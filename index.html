<html>
    <head>
        <title>Weasel Program</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" type="text/css" />
        <style>
            .leftcolumn {
                position: absolute;
                left: 0;
                width: 50%                
            }
            .rightcolumn {
                position: absolute;
                right: 0;
                width: 50%
            }
            .bottom {
                position: absolute;
                bottom: 0;
            }
            .monospace {
                font-family: "Courier New", Courier, monospace;
            }
        </style>
        <script>
            var targettext = 'METHINKS IT IS A WEASEL';
            var allowed_chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ ";
            
            function mutate(string, mutation_rate) {
                var result = "";
                for (var i=0; i < string.length; i++) {
                    var new_char;
                    if (Math.random() < mutation_rate) {
                        result += get_random_char();
                    } else {
                        result += string[i];
                    }
                }
                return result;
            }
            
            function mutation_set(string, target, generation_size, mutation_rate) {
                var best_score = -1;
                var best_string = '';
                for (var i=0; i < generation_size; i++) {
                    var new_string = mutate(string, mutation_rate);
                    var new_score = compute_score(new_string, target);
                    if (new_score > best_score) {
                        best_score = new_score;
                        best_string = new_string;
                    }
                }
                return best_string;
            }
            
            // getting a random string modified from
            // http://stackoverflow.com/questions/1349404/generate-a-string-of-5-random-characters-in-javascript
            function makeid(length) {
                var text = "";
                for (var i=0; i < length; i++) {
                    text += get_random_char();
                }
                return text;
            }
            function get_random_char() {
                return allowed_chars.charAt(Math.floor(Math.random() * allowed_chars.length));
            }
            
            function do_analysis(target) {
                target = target.toUpperCase();
                var table = $('#generations');
                table.html('<tr><th>Iteration</th><th>Phrase</th><th>Score</th></tr>');
                var string = makeid(target.length);
                var score = compute_score(string, target);
                var generation_size = $("#generationspinner").val();
                var mutation_rate = $("#mutationspinner").val() * 0.01;
                table.append(generation_row(0, string, score));
                var i = 0;
                while (score < target.length) {
                    string = mutation_set(string, target, generation_size, mutation_rate);
                    score = compute_score(string, target);
                    i += 1;
                    table.append(generation_row(i, string, score));
                }
            }
            
            function generation_row(generation, string, score) {
                // TODO: highlight matches
                return "<tr><td style='width:5em'>" + generation + "</td><td style='width:25em' class='monospace'>" + string + "</td><td width='5em'>" + score + "</td>";
            }
            
            function compute_score(test, target) {
                var score = 0;
                for (var i=0; i<target.length; i++) {
                    if (test[i] == target[i]) {
                        score++;
                    }
                }
                return(score);
            }
            
            $(function() {
                $('#gobutton').button().click(function(event) {
                    do_analysis($('#targettext').val());
                });
                $('#mutationspinner').spinner();
                $('#generationspinner').spinner();
                $('#targettext').val(targettext);
                // code for allowing only letters and space (slightly) adapted from
                // http://stackoverflow.com/questions/2980038/allow-text-box-only-for-letters-using-jquery
                $("#targettext").on("keydown", function(event){
                    // Ignore controls such as backspace
                    var arr = [8,16,17,20,35,36,37,38,39,40,45,46];

                    // allow space
                    arr.push(32);

                    // Allow letters
                    for(var i = 65; i <= 90; i++){
                        arr.push(i);
                    }

                    if(jQuery.inArray(event.which, arr) === -1){
                        event.preventDefault();
                    }
                });                
                
                $('#targettext').on("input", function(){
                    var regexp = /[^a-zA-Z ]/g;
                    if($(this).val().match(regexp)){
                        $(this).val( $(this).val().replace(regexp,'') );
                    }
                });                
            });
        </script>
    </head>
    <body width="100%" height="100%">
        <div class="leftcolumn" style="top:0; bottom:0">
            <p>
                The <a href="http://en.wikipedia.org/wiki/Weasel_program">Weasel Program</a> is a demonstration of the power of
                evolutionary algorithms with an appropriate fitness function (i.e. survival rule). These algorithms find the solution
                much more efficiently than non-directed random mutation.
            </p>
        
            Text to evolve toward:
            <!-- learned about text-transform style from http://stackoverflow.com/questions/3724972/how-to-change-the-input-to-uppercase-as-it-is-being-typed -->
            <input type="text" id="targettext" value="" style="width:30em; text-transform: uppercase;"></input><br/>
            <label for="mutationspinner">Mutation rate:</label>
            <input id="mutationspinner" name="value" value="5"/>%<br/>
            Size of each generation: <input id="generationspinner" name="value" value="100"/><br/>
            <button id="gobutton">Go</button>
            <div class="bottom">
                Graphical analysis will go here.<br/>
                sdf<br/>
                bad<br/>
                as
            </div>
        </div>
        <div class="rightcolumn" style="overflow: auto; top:0; bottom:0">
            <table id="generations">
            </table>
        </div>
    </body>
</html>
